= Customization and Configuration
:page-layout: classic-docs
:page-liquid:
:icons: font
:toc: macro
:toc-title:

The following sections summarize the key files and variables that impact CircleCI Server behavior, and configuration options for your Server installation.

toc::[]

== Notable Files & Folders

[.table.table-striped]
[cols=3*, options="header", stripes=even]
|===
| Need
| Path
| More info

| General Config
| `/etc/circle-installation-customizations`
| See table below for values

| JVM Heap Sizes
| `/etc/circleconfig/XXXX/customizations`  Supports: frontend, test_results
| Adjust heap size for individual containers with `JVM_HEAP_SIZE`

| Custom CA Certs
| `/usr/local/share/ca-certificates/`
|

| Container Customizations
| `/etc/circleconfig/XXX/customizations`
| Used lots of places in replicated

| `/etc/hosts`
| `/etc/hosts`
| Respected by several containers including frontend, copied to container's /etc/hosts

| `/etc/environment`
| `/etc/environment`
| Respected by all containers
|===

=== Properties of `/etc/circle-installation-customizations`

NOTE: Every property should be in the format `export ENV_VAR="value"`

[.table.table-striped]
[cols=3*, options="header", stripes=even]
|===
| Property
| Impact
| More info

| CIRCLE_URL
| Override the scheme and host that CircleCI uses
|

| JVM_HEAP_SIZE
| Set JVM heap size for *all* containers reading this property
| Use container specific settings when possible (see files above)
|===

=== Other Properties and Env Vars

[.table.table-striped]
[cols=3*, options="header", stripes=even]
|===
| Property
| Impact
| More info

| HTTP_PROXY, NO_PROXY
| Proxy for replicated and other services outside CircleCI containers to use
|
|===

<<<

== Service Configuration Overrides
This section describes the configuration interface for overriding services in CircleCI Server.

WARNING: Customizing your configuration can have potentially damaging consequences, so we recommend contacting support@circleci.com for guidance before making any changes.

Configuration is done by exporting environment variables in files located on the Services machine.

Consider the file “customizations” created at the following path /etc/circleconfig/workflows-conductor:

```shell
export FOO="bar"
```

The value of FOO will take precedence over the default values set in the default container mapping in the CircleCI Server configuration.

=== Available Overrides

```
/etc/circleconfig/api-service/customizations
/etc/circleconfig/audit-log-service/customizations
/etc/circleconfig/contexts-service-db-migrator/customizations
/etc/circleconfig/contexts-service/customizations
/etc/circleconfig/cron-service-db-migrator/customizations
/etc/circleconfig/cron-service/customizations
/etc/circleconfig/domain-service-migrator/customizations
/etc/circleconfig/domain-service/customizations
/etc/circleconfig/federations-service-db-migrator/customizations
/etc/circleconfig/federations-service-migrator/customizations
/etc/circleconfig/frontend/customizations
/etc/circleconfig/output-processor/customizations
/etc/circleconfig/permissions-service-migrator/customizations
/etc/circleconfig/permissions-service/customizations
/etc/circleconfig/picard-dispatcher/customizations
/etc/circleconfig/schedulerer/customizations
/etc/circleconfig/test-results/customizations
/etc/circleconfig/vm-gc/customizations
/etc/circleconfig/vm-scaler/customizations
/etc/circleconfig/vm-service-db-migrator/customizations
/etc/circleconfig/vm-service/customizations
/etc/circleconfig/workflows-conductor/customizations
```

=== Login Screen
You can add a banner to your login screen as follows:

. Access the file: `/etc/circleconfig/frontend/customizations` on the Services machine
. Add the following line, substituting the text you wish to display in the banner:
+
```
export CIRCLE__OUTER__LOGIN_BANNER_MESSAGE="<insert-your-message-here>
```
. Restart CircleCI from the Management Console (your-circleci-hostname.com:8800)

.Login Screen Banner Example
image::banner.png[]

=== Resource Classes
You can customize resource classes for your installation to provide developers with https://circleci.com/docs/2.0/optimizations/#resource-class[CPU/RAM options] per Job.

Following are the steps required to customize resource classes for the Docker and `machine` executors:

. SSH into the Services machine.
. Run the following:
+
```shell
sudo mkdir /etc/circleconfig/picard-dispatcher
```
. Run the following:
+
```shell
sudo vim /etc/circleconfig/picard-dispatcher/resource-definitions.edn
```
. Add your required customizations to the file, then save and exit vim with `:wq` - see below for options and formatting.
+
WARNING: It is imortant to use the IDs from the example below for the `machine` resources classes. IDs can, however, be changed for Docker resource classes.
. Run:
+
```shell
echo 'export CIRCLE_DISPATCHER_RESOURCE_DEF=/circleconfig/picard-dispatcher/resource-definitions.edn' | sudo tee /etc/circleconfig/picard-dispatcher/customizations
```
. Restart the CircleCI Server application ADD IN HOW HERE!

Below is an example resource class configuration:

Example config:

```
{:default-resource-class :medium

 :resource-classes
 {:docker
  {:small {:id "d1.small" :ga true :ui {:cpu 2.0 :ram 4096 :class :small} :outer {:cpu 2.0 :ram 4096}}
   :medium {:id "d1.medium" :ga true :ui {:cpu 4.0 :ram 8192 :class :medium} :outer {:cpu 4.0 :ram 8192}}
   :massive {:id "d1.massive" :ga true :ui {:cpu 7.0 :ram 28000 :class :massive} :outer {:cpu 7.0 :ram 28000}}}

  :machine
  {:medium {:id "l1.medium" :ga true :ui {:cpu 2.0 :ram 7680 :class :medium} :outer {:cpu 2.0 :ram 256}}
   :large {:id "l1.large" :ga true :ui {:cpu 4.0 :ram 16000 :class :large} :outer {:cpu 2.0 :ram 256}}}}}
```

Let's take a look at one of the options in more detail

```
:medium {:id "d1.medium" :ga true :ui {:cpu 4.0 :ram 8192 :class :medium} :outer {:cpu 4.0 :ram 8192}
```

* `:medium`  - this is the name that your developers will use to refer to the resource class in their config.yml and the is the external facing name of the resource class.
* `:id "d1.medium"`` - this is the internal name for the resource class. You can customize this ID for Docker resource classes but you will need to use the listed IDs for `machine` resources.
* `:ga true` - required field
* `:ui {:cpu 4.0 :ram 8192 :class :medium}` - Information used by the CircleCI UI. This this should be kept in parity with :outer - see below.
* `:outer {:cpu 4.0 :ram 8192}` - This defines the CPU and RAM for the resource class.

NOTE: Jobs can only run if the Nomad client has enough CPU/RAM in order to allocate the resources required. If not, the job will be queued.
