---

contentTags:
  platform:
  - クラウド
redirect_from: /ja/gitlab-vcs-support
---
= GitLab.com との連携
:page-layout: classic-docs
:page-liquid:
:page-description: GitHub と CircleCI の連携方法について説明します。
:icons: font
:toc: macro

:toc-title:

[#overview]
== 概要

このドキュメントでは、GitLab プロジェクトと CircleCI の連携について説明し、 CI/CD パイプラインを管理するための新しいコンセプトや方法を紹介します。 また、リリース予定の機能の概要もご紹介します。

[#sign-up]
== ユーザー登録

GitLab との連携は、新規および既存の CircleCI ユーザーに行っていただけます。 Follow the steps on the xref:first-steps#gitlab-signup[Sign up and try CircleCI] page to:

* GitLab アカウントを紐付けて組織を作成します。
* プロジェクトを作成し、GitLab アカウントからリポジトリに接続します。

リポジトリと CircleCI プロジェクトを接続すると、裏では CircleCI がお客様の GitLab リポジトリ内で Webhook を登録します。 これは、プロジェクトの作成に成功後、リポジトリの **Settings > Webhooks** のページに移動して確認することができます。

NOTE: 設定するレポジトリへの API アクセスと書き込みアクセス権が必要です。 GitLab では、これは "maintainer" 以上のロールです。

[NOTE]
====
現在下記の制限があります。

- 各ユーザーが作成できる組織は最大 3 つです。
- Free プランでは、各組織が作成できるプロジェクトは最大 10 個です。

If you need more organizations or projects, consider upgrading to a xref:plan-overview#[Paid plan], or link:https://support.circleci.com/hc/en-us/requests/new[contact our Support team].
====

[#trigger-pipeline]
== CircleCI でパイプラインをトリガーする

現時点では、新しい GitLab プロジェクトを設定しても、パイプラインは自動的にトリガーされません。 また、CircleCI 設定ファイルを CircleCI Web アプリ内で追加または編集することもできません。

. まだお済みでない場合は、GitLab リポジトリのルートで `.circleci` ディレクトリを作成し、そのディレクトリに `config.yml` ファイルを追加します。
+
NOTE: If you are new to CircleCI, you may wish to get started with our xref:hello-world#[Hello world] example, or take a look at some of our xref:sample-config#[sample configurations]. The xref:configuration-reference#[Configuring CircleCI] page is a full reference to the keys used in a `.circleci/config.yml` file.
. GitLab リポジトリに変更をプッシュします。 CircleCI Web アプリでプロジェクトのパイプラインが実行されます。
+
image::{{site.baseurl}}/assets/img/docs/gl-ga/gitlab-ga-successful-pipeline.png[Successful pipeline run]

[#project-settings]
== プロジェクト設定

GitHub プロジェクトや Bitbucket プロジェクトとは異なり、GitLab の連携では、一つの VCS に固有ではない「スタンドアロン」プロジェクトというコンセプトが導入されています。

プロジェクトには 1 つまたは複数の **設定ファイル** を含めることができます。設定ファイルとは、リポジトリ内の `.circleci/config.yml` ファイルをはじめとする、パイプラインの定義です。

プロジェクトには 1 つまたは複数の **トリガー** を含めることができます。トリガーとは、VCS をはじめとする、変更ソースからのイベントです。 トリガーによってパイプラインの開始に使用する設定ファイルが決まります。

プロジェクト内で **Project Settings** ボタンをクリックすると、以下の設定が表示されます。 現時点では、設定ファイルもトリガーも GitLab に限定されています。

[#people]
=== People

プロジェクトのロールにより、組織内でどのユーザーがどのプロジェクトにアクセスできるかをさらに細かく制御できます。 チームには自分たちのプロジェクトのみへのアクセス権を付与し、一方管理者などには組織のより広いアクセス権を付与することができます。 アクセス権のオプションは以下の通りです。

* Admin: プロジェクトや全設定の読み取りと書き込みアクセス権と他のユーザーのアクセス権の管理
* Contributor: プロジェクトや一部の設定の読み取りと書き込みアクセス権
* Viewer: プロジェクトや一部の設定の読み取りアクセス権のみ

すべての権限のリストは、 <<roles-and-permissions,Roles and permissions>> のセクションをご確認ください。

image::{{site.baseurl}}/assets/img/docs/gl-ga/gitlab-project-settings-project-roles.png[Project roles setup page]

[#configuration]
=== 設定

この時点で、プロジェクトの設定ソースを追加または削除することができます。 上記の手順で GitLab を接続したお客様は、GitLab の設定ソースが自動的に追加されています。 設定ソースを定義すると、その設定ファイルを参照するトリガーをセットアップできます。

image::{{site.baseurl}}/assets/img/docs/gl-ga/gitlab-ga-project-settings-configuration.png[Configuration setup page]

[#triggers]
=== トリガー

**現時点ではパイプラインのスケジュール実行機能は、GitLab では使用できません。** GitLab のトリガーについては以下をお読みください。フィルタリング機能を使って特定の条件に基づいてパイプラインをトリガーする方法も紹介します。

パイプラインを開始する設定ソースを指定するトリガーを追加します。 上記の手順で GitLab を接続したお客様は、GitLab を設定ソースとして設定されたトリガーが自動的に追加されています。

image::{{site.baseurl}}/assets/img/docs/gl-ga/gitlab-ga-project-settings-triggers.png[Trigger setup page]

トリガーとトリガールールにより、CircleCI が変更ソース (この場合はGitLab) からのイベントをどのように処理するかが決まります。

トリガーが作成されると、CircleCI は GitLab に Webhook を登録します。 GitLab からのプッシュイベントは CircleCI に送信されます。 CircleCI はその後、イベントデータを使って、パイプラインを実行すべきかどうかを決定し、実行する場合、どのパイプラインを実行すべきかを決定します。

設定ソースに加えて、各トリガーには Webhook の URL や、このシナリオでは、CircleCI が作成した GitLab トークンも含まれます。 GitLab レポジトリからプッシュイベントを受信するには、GitLab 内で Webhook URLと GitLab トークンを使用して、Webhook をセキュアに登録します。

image::{{site.baseurl}}/assets/img/docs/gl-ga/gitlab-ga-project-settings-edit-trigger.png[Trigger details]



**トリガーのフィルタリング** により、Gitlab の Webhook が提供するパラメーターに基づき、トリガーがビルドを開始するタイミングを決定できます。 CircleCI では、一般的なオプションを提供しており、例えば、ビルドはマージリクエストに基づいてのみ行い、フィルタリングのカスタマイズオプションを使って独自のルールを作成することも可能です。 フィルタリングのカスタマイズにより、例えば特定のブランチやユーザーにのみビルドすることができます。

image::{{site.baseurl}}/assets/img/docs/gl-preview/gitlab-preview-project-settings-customize-triggers.png[Trigger details]

NOTE: GitLab 連携では、以下のプロジェクト設定の機能の違いにも注意してください。

[#project-settings-advanced]
=== Advanced

- CircleCI でセットアップ ワークフローを使って、ダイナミックコンフィグを有効化できます。 To learn about dynamic configuration, read the xref:dynamic-config#[Dynamic configuration] guide.
- 現時点では、**Free and Open Source** 設定はサポートされていませんが、今後提供予定です。
- 現時点では、冗長ワークフローの自動キャンセルはサポートされていません。 Refer to the xref:skip-build#auto-cancelling[Auto cancelling] section of the `skip` or `cancel` jobs and workflows page for more details.

[#project-settings-ssh-keys]
=== Project SSH keys

プロジェクトを作成すると、 SSH キーが作成され、リポジトリからコードをチェックアウトする際にに使用されます。 作成した設定ファイルごとに、その設定ファイルに関連づけられたリポジトリのコードにアクセスするための新しい SSH キーが生成されます。 現時点では、GitLab プロジェクトには **Additional SSH Keys (追加 SSH キー)** のみが適用されます。

[#create-gitlab-ssh-key]
==== Create GitLab SSH key

. Create an SSH key-pair by following the link:https://docs.gitlab.com/ee/user/ssh.html[GitLab instructions]. When prompted to enter a passphrase, do **not** enter one (below is one example command to generate a key on macOS):
+
```shell
  ssh-keygen -t ed25519 -C "your_email@example.com"
```
. Go to your project on link:https://gitlab.com/[GitLab] and navigate to **Settings > Repository**, and expand the **Deploy keys** section. Title フィールドにタイトルを入力し、手順 1 で作成したパブリックキーをコピー＆ペーストします。 Check **Grant write permissions to this key** box, then click **Add key**.
. CircleCI アプリのプロジェクトの設定にアクセスし、**SSH Keys** と **Add SSH key** を選択します。 In the "Hostname" field, enter `gitlab.com` and add the private key you created in step 1. 次に **Add SSH Key** をクリックします。
. `.circleci/config.yml` ファイルで、`add_ssh_keys` キーを使用してジョブにフィンガープリントを追加します。
+
```yaml
  version: 2.1

  jobs:
    deploy-job:
      steps:
        - add_ssh_keys:
            fingerprints:
              - "SO:ME:FIN:G:ER:PR:IN:T"
```

When you push to your GitLab repository from a job, CircleCI will use the SSH key you added.

For more information on SSH keys, please visit the xref:add-ssh-key#[Adding an SSH key to CircleCI] page.

[#organization-settings]
== 組織設定

GitLab の連携では、特定の VCS に関連づけられない「スタンドアロン」組織のコンセプトも導入されています。

スタンドアロン組織は、VCS に関係なくユーザーやプロジェクトを管理することができます。 組織やユーザーは、CircleCI の組織やユーザーとみなされ、VCS で定義づけられたロールや権限に依存せず、独自のロールや権限を持ちます。

組織レベルで設定を管理するには、CircleCI Web アプリの **Organization Settings** ボタンをクリックします。

[#organization-settings-people]
=== People

ユーザーを追加または削除し、組織のユーザーロールやユーザーの招待を管理します。

NOTE: 少なくとも１名の組織管理者が必要です。 最後の組織管理者を削除しようとすると、エラーになります。

[#inviting-your-first-team-members]
==== 最初のチームメンバーを招待する

新しい組織を作成したら、オプションでダッシュボードからチームメンバーを招待できます。 または、 **Organization Settings** の **People** のセクションからチームメンバーを招待することも可能です。

image::{{site.baseurl}}/assets/img/docs/gl-preview/gitlab-preview-org-settings-people.png[People section under Organization Settings]

. **Invite** ボタンをクリックします。
. 招待したいユーザーのメールアドレスを入力し、適切なロールを選択します。 複数のユーザーに同じロールをアサインする場合は、複数のアドレスを同時に入力できます。
+
現時点では、組織管理者ロールと組織コントリビューターロールが使用できます。 プロジェクト固有のロールも間もなく追加されます。 For more information, refer to the <<#about-roles-and-permissions,Roles and permissions>> section.
. 招待されたユーザーは、招待を受けるためのリンクが含まれたメール通知 (`noreply@circleci.com` から送信) を受け取ります。
+
ユーザーが CircleCI アカウントをお持ちでない場合は、登録する必要があります。 既に CircleCI アカウントをお持ちの場合、ユーザーは組織に追加されます。ユーザーがログインすると、Web アプリの左上にある組織切替メニューにその組織がオプションとして表示されます。

[#roles-and-permissions]
== ロールと権限

CircleCI のユーザーは、個々の組織で割り当てられたロールによって、可能な操作が異なります。

CircleCI ユーザーのロールと権限は、VCS の権限から派生するものではありません。また、VCS の権限を無視することもできません。 たとえば、CircleCI の _Organization Administrator (組織の管理者)_ である場合、CircleCI 組織内の組織とプロジェクト設定の閲覧および変更が可能です。 しかし、VCS にホストされているプロジェクトの `.circleci/config.yml` ファイルを編集するには、VCS のリポジトリ内のプロジェクトに対して書き込みアクセス権が付与されている必要があります。 CircleCI ユーザーの VCS における権限は、関連づけられた GitLab のアイデンティティによって決まります。

現時点では、トリガーや設定ファイルを管理する際に CircleCI と接続することにより GitLab のアイデンティティを管理できます。

[#organization-role-permissions-matrix]
=== 組織のロールと権限のマトリックス

[.table.table-striped]
[cols=4*, options="header"]
|===
|アクション
|組織のロール

|
|*Admin*
|*Contributor*
|*Viewer*

|*組織*
|
|
|

^|名前空間の作成
|icon:check-circle[]
^|
^|

^|名前空間の管理
|icon:check-circle[]
^|
^|

^|組織設定の閲覧
|icon:check-circle[]
^|icon:check-circle[]
^|icon:check-circle[]

^|組織設定の管理
|icon:check-circle[]
^|
^|

^|組織のアクセス権の閲覧
|icon:check-circle[]
^|icon:check-circle[]
^|icon:check-circle[]

^|組織のアクセス権の管理
|icon:check-circle[]
^|
^|

^|組織の認証情報の閲覧
|icon:check-circle[]
^|icon:check-circle[]
^|icon:check-circle[]

^|組織のポリシーの閲覧
|icon:check-circle[]
^|icon:check-circle[]
^|icon:check-circle[]

^|組織のポリシーの管理
|icon:check-circle[]
^|
^|

^|組織の連携情報の閲覧
|icon:check-circle[]
^|icon:check-circle[]
^|icon:check-circle[]

^|組織の連携情報の管理
|icon:check-circle[]
^|
^|

^|組織のリリース情報の閲覧
|icon:check-circle[]
^|icon:check-circle[]
^|

^|組織の認証情報の管理
|icon:check-circle[]
^|
^|

^|組織の監査ログの閲覧
|icon:check-circle[]
^|
^|

^|プランの閲覧
|icon:check-circle[]
^|icon:check-circle[]
^|

^|プランの管理
|icon:check-circle[]
^|
^|

|*Insights*
|
|
|

^|組織の Insights の閲覧
|icon:check-circle[]
^|icon:check-circle[]
^|icon:check-circle[]

|*ランナー*
|
|
|

^|ランナーの閲覧
|icon:check-circle[]
^|icon:check-circle[]
^|icon:check-circle[]

^|ランナーの管理
|icon:check-circle[]
^|
^|

|*プロジェクト*
|
|
|

^|プロジェクトの閲覧
|icon:check-circle[]
^|icon:check-circle[]
^|icon:check-circle[]

^|プロジェクトの作成
|icon:check-circle[]
^|icon:check-circle[]
^|

^|プロジェクト設定の管理
|icon:check-circle[]
^|
^|

^|プロジェクトのバージョンの復元
|icon:check-circle[]
^|
^|

^|プロジェクトのカナリアの削除
|icon:check-circle[]
^|
^|

|*コンテキスト*
|
|
|

^|コンテキストの閲覧
|icon:check-circle[]
^|icon:check-circle[]
^|icon:check-circle[]

^|コンテキストの使用
|icon:check-circle[]
^|icon:check-circle[]
^|

^|コンテキストの変数の編集
|icon:check-circle[]
^|icon:check-circle[]
^|

^|コンテキストの管理
|icon:check-circle[]
^|
^|

|*Orb*
|
|
|

^|Orb の作成/更新
|icon:check-circle[]
^|
^|

^|プライベート Orb の閲覧
|icon:check-circle[]
^|icon:check-circle[]
^|icon:check-circle[]

^|開発版 Orb のパブリッシュ
|icon:check-circle[]
^|icon:check-circle[]
^|

^|Orb のパブリッシュ
|icon:check-circle[]
^|
^|

|*Webhook*
|
|
|

^|組織の Webhook の閲覧
|icon:check-circle[]
^|icon:check-circle[]
^|

^|組織の Webhook の管理
|icon:check-circle[]
^|
^|

^|プロジェクトの Webhook の閲覧
|icon:check-circle[]
^|icon:check-circle[]
^|

^|プロジェクトの Webhook の管理
|icon:check-circle[]
^|
^|

|*スケジュール*
|
|
|

^|スケジュールの閲覧
|icon:check-circle[]
^|icon:check-circle[]
^|icon:check-circle[]

^|スケジュールの編集
|icon:check-circle[]
^|
^|

|*トリガー*
|
|
|

^|トリガーの閲覧
|icon:check-circle[]
^|icon:check-circle[]
^|icon:check-circle[]

^|ビルドのトリガー
|icon:check-circle[]
^|icon:check-circle[]
^|

^|トリガーの編集
|icon:check-circle[]
^|
^|

|*設定ファイルソース*
|
|
|

^|設定ファイルソースの閲覧
|icon:check-circle[]
^|icon:check-circle[]
^|icon:check-circle[]

^|設定ファイルソースの編集
|icon:check-circle[]
^|
^|
|===

[#project-role-permissions-matrix]
=== プロジェクトのロールと権限のマトリックス

[.table.table-striped]
[cols=4*, options="header"]
|===
|アクション
|プロジェクトのロール

|
|*Admin*
|*Contributor*
|*Viewer*

|*プロジェクト*
|
|
|

^|プロジェクトの閲覧
|icon:check-circle[]
^|icon:check-circle[]
^|icon:check-circle[]

^|プロジェクトのアクセス権の閲覧
|icon:check-circle[]
^|icon:check-circle[]
^|icon:check-circle[]

^|プロジェクトの認証情報の閲覧
|icon:check-circle[]
^|icon:check-circle[]
^|icon:check-circle[]

^|プロジェクトのバージョンの復元
|icon:check-circle[]
^|icon:check-circle[]
^|

^|プロジェクトのカナリアの削除
|icon:check-circle[]
^|icon:check-circle[]
^|

^|プロジェクトの管理
|icon:check-circle[]
^|
^|

|*Webhook*
|
|
|

^|プロジェクトの Webhook の閲覧
|icon:check-circle[]
^|icon:check-circle[]
^|icon:check-circle[]

^|プロジェクトの Webhook の管理
|icon:check-circle[]
^|
^|

|*スケジュール*
|
|
|

^|スケジュールの閲覧
|icon:check-circle[]
^|icon:check-circle[]
^|icon:check-circle[]

^|スケジュールの編集
|icon:check-circle[]
^|
^|

|*トリガー*
|
|
|

^|トリガーの閲覧
|icon:check-circle[]
^|icon:check-circle[]
^|icon:check-circle[]

^|ビルドのトリガー
|icon:check-circle[]
^|icon:check-circle[]
^|

^|トリガーの編集
|icon:check-circle[]
^|
^|

|*設定ファイルソース*
|
|
|

^|設定ファイルソースの閲覧
|icon:check-circle[]
^|icon:check-circle[]
^|icon:check-circle[]

^|設定ファイルソースの編集
|icon:check-circle[]
^|
^|
|===

[#user-settings]
== ユーザー設定

[#user-account-integrations]
=== アカウントの連携

CircleCI のユーザープロフィール内の **User Settings** セクションで、複数のアカウント連携を有効化できます。

image::{{site.baseurl}}/assets/img/docs/gl-ga/gitlab-ga-account-integrations.png[User account integrations page]

CircleCI で複数のアカウント連携ができることにより、以下が実現できます。

- アカウントの全てのソースコントロールに容易にアクセスする
- CircleCI で利用可能な全ての認証方法を使用する

[#deprecated-system-environment-variables]
== 非推奨のシステム環境変数

GitLab ベースのプロジェクトでは以下のシステム環境変数が使用できません。 If your pipelines need these environment variables, we recommend you use suitable replacements from the available <<pipeline-variables#,pipeline values>>.

[.table.table-striped]
[cols=2*, options="header"]
|===
|名前
|説明

|`CI_PULL_REQUESTS`
|現在のビルドに関連付けられたプルリクエストの URL の一覧 (カンマ区切り)。

|`CI_PULL_REQUEST`
|関連付けられたプルリクエストの URL。 複数のプル リクエストが関連付けられている場合は、いずれか 1 つの URL がランダムに選択されます。

|`CIRCLE_PR_NUMBER`
|関連付けられた GitHub または Bitbucket プルリクエストの番号。 フォークしたプルリクエストのみで使用可能です。

|`CIRCLE_PR_USERNAME`
|プルリクエストを作成したユーザーの GitHub または Bitbucket ユーザー名。 フォークしたプルリクエストのみで使用可能です。

|`CIRCLE_PR_REPONAME`
|プルリクエストが作成された GitHub または Bitbucket リポジトリの名前。 フォークしたプルリクエストのみで使用可能です。

|`CIRCLE_PROJECT_USERNAME`
|現在のプロジェクトの GitHub または Bitbucket ユーザー名

|`CIRCLE_PROJECT_REPONAME`
|現在のプロジェクトのリポジトリの名前

|`CIRCLE_REPOSITORY_URL`
|GitHub または Bitbucket リポジトリ URL

|`CIRLCE_SHA1`
|現在のビルドの前回のコミットの SHA1 ハッシュ

|`CIRCLE_TAG`
|Git タグの名前 (現在のビルドがタグ付けされている場合)。 For more information, see the xref:workflows#executing-workflows-for-a-git-tag[Git tag job execution] section of the Using workflows to orchestrate jobs page.
|===

If you must use these as environment variables in your pipelines, you can do so by using the xref:env-vars#environment-variable-usage-options[`environment` key] in your configuration and providing your own mappings:

```yaml
build:
  docker:
    - image: cimg/node:17.0
      auth:
        username: mydockerhub-user
        password: $DOCKERHUB_PASSWORD  # context / project UI env-var reference
  environment:
    CIRCLE_PROJECT_REPONAME: << pipeline.trigger_parameters.gitlab.repo_name >>
  steps:
    - run: echo $CIRCLE_PROJECT_REPONAME
```

[#coming-soon]
== 近日公開予定

下記のセクションでは、GitLab 連携では現在はまだフルサポートされていない CircleCI の機能を紹介します。 これらの機能は、今後リリースされる予定です。

[#account-integrations]
=== アカウントの連携

現在、プロジェクト設定、トリガー、および設定ファイル以外に GitLab との接続を管理する方法はありません。 CircleCI では、ユーザープロフィール内の Account Integration の設定でユーザーの GitLab アイデンティティを管理できるよう取り組んでいます。

[#auto-cancel-redundant-workflows]
=== 冗長ワークフローの自動キャンセル

冗長ワークフローの自動キャンセルは、現時点ではサポートされていません。 この機能は、パイプラインのページからノイズを取り除き、コミットのフィードバックにかかる時間を短縮するためによく使用されます。 Refer to the xref:skip-build#auto-cancelling[Skip or cancel jobs and workflows] page for more details.

[#passing-secrets-to-forked-pull-requests]
=== フォークしたプルリクエストにシークレットを渡す

現在、GitLab 連携ではフォークしたプルリクエストにシークレットを渡すオプションはサポートされていません。

[#stop-building]
=== ビルドの停止

現在、GitLab 連携では **Stop Building** オプションをサポートしていません。(このオプションは通常は **Project settings** 内にあります。) CircleCI パイプラインの実行を停止したい場合は、GitLab リポジトリの Webhook を削除することを推奨します。

[#ssh-rerun]
=== SSH での再実行

SSH での再実行は、ユーザーのアカウントが GitLab に加えて Bitbucket または GitHub と連携している場合にのみサポートされます。 ユーザーアカウントの Bitbucket または GitHub の SSH キーは、GitLab の SSH での再実行に使用できます。 ユーザーが SSH キーを管理し、SSH 再実行ができるようにする機能を追加予定です。 SSH での再実行には、コンテキストシークレットは渡されません。 CircleCI では、管理者がシークレットの使用と SSH での再実行をより詳細に制御できるよう取り組んでいます。

[#additional-ssh-keys-only]
=== 追加 SSH キーのみ

GitLab の連携では、デプロイキーとユーザーキーは使用されません。 GitLab のキーは、 **Project Settings > Additional SSH Keys** に保存されます。 ただし、CircleCI はユーザーがコードのチェックアウトのための SSH キーを手動で管理することを推奨しません。 代わりに、 **Set Up Project** オプションまたは **Project Settings > Configuration** を使用し、リポジトリとの接続を維持して下さい。

[#free-and-open-source-setting]
=== Free とオープンソースの設定

現在、GitLab のお客様には、オープンソースプランはご利用いただけません。 CircleCI ではオープンソースコミュニティを最新の状態に保ち、将来的にはサポートを提供予定です。

[#next-steps]
== 次のステップ

- xref:config-intro#[Configuration tutorial]
- xref:hello-world#[Hello world]