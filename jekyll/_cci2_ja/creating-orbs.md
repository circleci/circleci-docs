---
layout: classic-docs
title: "Orb のパブリッシュ"
short-title: "Orb のパブリッシュ"
description: "Orb レジストリへの Orb のパブリッシュ"
categories:
  - getting-started
order: 1
version:
  - クラウド
---

ここでは、Orb のパブリッシュ手順について説明します。

* TOC
{:toc}

## はじめに
{: #introduction }

After authoring your orb, you can publish it with a [semantically versioned]({{site.baseurl}}/2.0/orb-concepts/#semantic-versioning) tag, and the orb will appear publicly on the [Orb Registry](https://circleci.com/developer/orbs).

![Orb Publishing Process]({{ site.baseurl }}/assets/img/docs/orb-publishing-process.png)

## Orb development kit
{: #orb-development-kit }

If you are publishing your orb using the [Orb Development Kit]({{site.baseurl}}/2.0/orb-author/#orb-development-kit), rather than [manually]({{site.baseurl}}/2.0/orb-author-validate-publish), semantic releases are straight-forward using the steps set out in the following section. You can find a simplified version of the publishing process in the [README.md](https://github.com/CircleCI-Public/Orb-Project-Template/blob/master/README.md) file that was generated by the `circleci orb init` command at the start of the authoring process.

### Issue a new release
{: #issue-a-new-release }

The steps below show how to issue a new semantic release of your orb. Once you have generated your orb sample project with the `circleci orb init` command, you will have been automatically migrated to the `alpha` branch. The name of the branch does not matter, just ensure any new features, bug fixes, or patches, are created in a non-default branch for your repository. Once you have added or updated your code and are ready to issue a release, continue with these steps.

1. **Open a new Pull Request to the default branch.** <br/> New releases are only published on merges to the default branch. Orb の[パッケージ化]({{site.baseurl}}/2.0/orb-concepts/#orb-packing)、[テスト]({{site.baseurl}}/2.0/testing-orbs/)、パブリッシュは、サンプルに含まれる [`.circleci/config.yml` 設定ファイル](https://github.com/CircleCI-Public/Orb-Project-Template/blob/master/.circleci/config.yml)により自動的に行われます。 この CI パイプラインでは、デフォルトで[結合テスト]({{site.baseurl}}/2.0/testing-orbs/#integration-testing)と[単体テスト]({{site.baseurl}}/2.0/testing-orbs/#unit-testing)が有効になっています。 Orb が正常に機能するかを確認するため、少なくとも結合テストは有効にしておくことを強くお勧めします。 Orb でスクリプトを使用しない場合や、現時点では単体テストを有効にしたくない場合は、[bats/run](https://github.com/CircleCI-Public/Orb-Project-Template/blob/0354adde8405564ee7fc77e21335090a080daebf/.circleci/config.yml#L49) ジョブをコメントアウトしてください。

1. **Ensure all tests pass.** <br/> You can view the results of your tests directly on GitHub within the Pull Request, or, for a more detailed view, watch the entire pipeline on CircleCI.com. ![プル リクエストに対して GitHub Checks API から返された Orb のテスト結果レポート]({{site.baseurl}}/assets/img/docs/orb-dev-kit-gh-checks.png)

1. **Title Pull Request with Special Semver Tag.** <br/> The included CI config uses the [orb-tools orb](https://circleci.com/developer/orbs) to automatically publish orbs that pass testing on the default branch, provided that the commit message contains the correct tag designated the intended [semver]({{site.baseurl}}/2.0/orb-concepts/#semantic-versioning) release.<br/> The tag template looks like this: `[semver:<increment>]`, where `<increment>` is replaced with one of the following values:

    | increment の値 | 説明                             |
    | ------------ | ------------------------------ |
    | major        | リリースのバージョン番号を 1.0.0 だけ増やして公開する |
    | minor        | リリースのバージョン番号を x.1.0 だけ増やして公開する |
    | patch        | リリースのバージョン番号を x.x.1 だけ増やして公開する |
    | skip         | リリースを公開しない                     |
    {: class="table table-striped"}

    たとえば、`alpha` ブランチから Orb のメジャー バージョン リリースを初めて公開する場合は、プル リクエストのタイトルを `[semver:major] 初回 Orb リリース` のように設定します。 ![Orb の初回メジャー リリース - プル リクエスト]({{site.baseurl}}/assets/img/docs/orb_semver_release_pr.png)

1. **"Squash" Merge.** <br/> Performing a [squash](https://docs.github.com/en/github/collaborating-with-issues-and-pull-requests/about-pull-request-merges#squash-and-merge-your-pull-request-commits) merge not only condenses the branch into a single commit when merging into the default branch, but it also keeps the title of the Pull Request as the commit message. ![プル リクエストをスカッシュ マージして semver タイトルを保持する]({{site.baseurl}}/assets/img/docs/orb_semver_squash_merge.png)

1. **Complete!** <br/> If you head over to the [CircleCI app](https://app.circleci.com/) you can view the progress of your orb publishing pipeline. このパイプラインが完了したら、[Orb レジストリ](https://circleci.com/developer/ja/orbs) に Orb が公開されます。

### Orb publishing process
{: #orb-publishing-process }

If you want to dive deeper into the orb development kit and get a look at how the components work together to publish your orb, this section is for you.

The [circleci orb init]({{site.baseurl}}/2.0/orb-author/#getting-started) command is responsible for cloning an [orb template repository](https://github.com/CircleCI-Public/Orb-Project-Template) for your orb, including a pre-defined CircleCI configuration file designed with our optimal orb development pipeline.

Included in the [/.circleci](https://github.com/CircleCI-Public/Orb-Project-Template/tree/master/.circleci) directory is a README with a breakdown of the included workflows.

Your orb pipeline occurs across two workflows:
* [test-pack](#test-pack)
* [integration-test_deploy](#integration-test_deploy)

#### test-pack
{: #test-pack }

[`test-pack`](https://github.com/CircleCI-Public/Orb-Project-Template/blob/0354adde8405564ee7fc77e21335090a080daebf/.circleci/config.yml#L40) is the first of two workflows to run, and will execute each time code is committed to the repository on **any** branch.

The `test-pack` workflow is responsible for all testing that happens prior to a development version of the orb being published. Integration tests (which happen in the next workflow) can only run once the development version of the orb is available to run the tests on.

A development version of the orb is created in the [orb-tools/publish-dev](https://github.com/CircleCI-Public/Orb-Project-Template/blob/0354adde8405564ee7fc77e21335090a080daebf/.circleci/config.yml#L62) job, and this job requires access to the Personal Access Token, which is secured in a [Restricted Context]({{site.baseurl}}/2.0/contexts/#restricting-a-context). Using a Restricted Context in this way allows us to store our token as an environment variable such that the job can only be triggered by someone with access to the Context, therefore 'securing' the publishing stage.

The workflow runs as follows:

* パーソナル アクセス トークンへの特別なアクセス権が不要なテストが実行されます。このステージは、オープン ソースのプル リクエストから実行可能です。
* ワークフローが[保留](https://github.com/CircleCI-Public/Orb-Project-Template/blob/0354adde8405564ee7fc77e21335090a080daebf/.circleci/config.yml#L54)状態になり、[手動での承認]({{site.baseurl}}/2.0/workflows/#%E6%89%8B%E5%8B%95%E6%89%BF%E8%AA%8D%E5%BE%8C%E3%81%AB%E5%87%A6%E7%90%86%E3%82%92%E7%B6%9A%E8%A1%8C%E3%81%99%E3%82%8B%E3%83%AF%E3%83%BC%E3%82%AF%E3%83%95%E3%83%AD%E3%83%BC)を求められます。 ![Manually approve publishing development orbs]({{site.baseurl}}/assets/img/docs/orb-publish-approval.png) The workflow will wait for a button click, via an alert prompt in the CircleCI app, before continuing.
* 手動承認によって認証が行われると、以降のジョブも自動的に認証され、制限付きコンテキストへのアクセス権が付与されます。 このようにすることで、オープンソースのプル リクエストによる Orb に対するビルドを可能にしながら、悪意のあるコードを防止しています。
* ワークフローが承認されると、[orb-tools/publish-dev](https://github.com/CircleCI-Public/Orb-Project-Template/blob/0354adde8405564ee7fc77e21335090a080daebf/.circleci/config.yml#L62) ジョブにより、開発版の Orb が次のように 2 回パブリッシュされます。

    | パブリッシュされる開発タグ                                          | 説明                                         |
    | ------------------------------------------------------ | ------------------------------------------ |
    | `<namespace>/<orb>@dev:<branch>`     | ブランチ名にリンクされる開発タグです。 設定ファイルのテストを行う場合に使用します。 |
    | `<namespace>/<orb>@dev:${CIRCLE_SHA1:0:7}` | この SHA に固有の開発タグです。 次のワークフローで使用します。         |
    {: class="table table-striped"}

You can learn more about the testing jobs in the [Orb Testing Methodologies]({{site.baseurl}}/2.0/testing-orbs) guide.

#### integration-test_deploy
{: #integration-testdeploy }

[`integration-test_deploy`](https://github.com/CircleCI-Public/Orb-Project-Template/blob/0354adde8405564ee7fc77e21335090a080daebf/.circleci/config.yml#L78) is the second and last workflow to run in our orb development pipeline. This workflow is automatically triggered, via the API, at the end of the `test-pack` workflow. This new workflow has access to the unique [development version]({{site.baseurl}}/2.0/orb-concepts/#orb-versions-development-vs-production-vs-inline) of the orb that was produced by the `test-pack` workflow.

This second stage of the pipeline runs the [integration tests]({{site.baseurl}}/2.0/testing-orbs/#integration-testing), testing the new orb's functionality that has just been added and published to the development version..

After integration testing, and only on the default branch, the deployment job will run. [orb-tools/dev-promote-prod-from-commit-subject](https://circleci.com/developer/orbs/orb/circleci/orb-tools#commands-dev-promote-from-commit-subject) is responsible for taking the SHA specific development version of the orb, and promoting it to a semantically versioned public release.

{% raw %}
```
      - orb-tools/dev-promote-prod-from-commit-subject:
          orb-name: <namespace>/<orb-name>
          context: <publishing-context>
          add-pr-comment: false
          fail-if-semver-not-indicated: true
          publish-version-tag: false
          requires:
            - integration-test-1
          filters:
            branches:
              only: <your default branch>
```
{% endraw %}

The `fail-if-semver-not-indicated` parameter is set to true by default, ensuring any commits without the proper [semver tag](#issue-a-new-release) in the commit title, result in a failed build.

You can optionally enable additional features such as publishing a version tag back to GitHub, and automatically posting new versions to the pull request via comment.

##### Publish version tag to GitHub
{: #publish-version-tag-to-github }

Your CircleCI orb will ultimately be hosted and displayed on the [Orb Registry](https://circleci.com/developer/orbs), however, if you would like to track your releases on GitHub, it is possible to automatically publish a version tag from CircleCI.

To push a tag to GitHub, CircleCI will need a [deploy key with write access]({{site.baseurl}}/2.0/add-ssh-key/#circleci-cloud). Follow the linked docs to generate and add your deploy key. When complete, you will see a "fingerprint" generated `"SO:ME:FIN:G:ER:PR:IN:T"` for that key. Add your SSH fingerprint to your `orb-tools/dev-promote-prod-from-commit-subject` job via the `ssh-fingerprints` parameter.

{% raw %}
```
      - orb-tools/dev-promote-prod-from-commit-subject:
          publish-version-tag: true
          ssh-fingerprints: "SO:ME:FIN:G:ER:PR:IN:T"
```
{% endraw %}

You can find a full set of available commands, jobs and parameters for the [orb-tools orb](https://circleci.com/developer/orbs/orb/circleci/orb-tools) on the [Orb Registry](https://circleci.com/developer/orbs/orb/circleci/orb-tools).
