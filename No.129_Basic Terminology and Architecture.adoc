---
version:
- Server v3.x
- サーバー管理
---
= Nomad クラスタの操作ガイド
:page-layout: classic-docs
:page-liquid:
:icons: font
:toc: macro
:toc-title:

CircleCI では、プライマリ ジョブ スケジューラとして https://www.hashicorp.com/blog/nomad-announcement/[Nomad] を使用します。ここでは、Nomad の基本的な概要と、CircleCI Server v3.x で Nomad クラスタを操作、管理する方法について説明します。

toc::[]

== 基本的な用語とアーキテクチャ

.Nomad クラスタの管理
image::nomad-diagram-v2.png[Nomad クラスタ]
<<<
- **Nomad サーバー:**Nomad サーバーは、Nomad クラスタの "頭脳" です。ジョブを受け取り、Nomad クライアントに割り当てます。CircleCI Server v3.x では、Nomad サーバーはクラスタ内でサービスとして実行されます。

- **Nomad クライアント:**Nomad クライアントは、Nomad サーバーによって割り当てられたジョブを実行します。通常、Nomad クライアントは専用のマシン (多くの場合は VM) 上で実行されるため、マシンの能力を最大限に活用できます。複数の Nomad クライアントを束ねて 1 つのクラスタを構成できます。Nomad サーバーはスケジュール アルゴリズムに従ってクラスタにジョブを割り当てます。

- **Nomad ジョブ:**Nomad ジョブは、Nomad のワークロードを宣言する仕様で、ユーザーが用意します。CircleCI では、Nomad ジョブは https://circleci.com/docs/ja/2.0/concepts/#jobs[CircleCI のジョブ]の実行と対応しています。たとえば、CircleCI のジョブ構成で、使用するhttps://circleci.com/docs/ja/2.0/parallelism-faster-jobs/[並列処理]が 10 に指定されている場合、Nomad では 10 個のジョブが実行されます。

- **ビルド エージェント:**ビルド エージェントは CircleCI 製の Go プログラムです。ジョブ内のステップを実行し、結果を報告します。ビルド エージェントは、Nomad ジョブ内でメイン プロセスとして実行されます。

== 基本的な操作

ここでは、CircleCI での Nomad クラスタの基本的な操作について説明します。

`nomad` CLI がクラスタ内の `circleci-nomad-0` Pod にインストールされています。以下で説明するコマンドを使用して、Nomad クラスタを検査、管理できます。

Terraform のセットアップ プロセスを行う中で有効な SSH キーを指定していれば、個々の Nomad クライアントにアクセスすることもできます。

=== ジョブ ステータスの確認

クラスタ内のすべてのジョブのステータス一覧を表示するには、以下のコマンドを実行します。

```sh
kubectl exec circleci-nomad-0 -it -- nomad status
```

`status` フィールドは、出力内容のうち最も重要で、以下のステータス タイプが定義されています。

- `running`: Nomad でジョブの実行が開始されています。通常、このジョブは、CircleCI 内のジョブです。

- `pending`: クラスタ内に、ジョブを実行するためのリソースが不足している状態です。

- `dead`: Nomad でジョブの実行が終了しました。`dead` ステータスは、対応する CircleCI ジョブ/ビルドの成否にかかわらず、ジョブが終了すると表示されます。

=== クラスタ ステータスの確認

Nomad クライアントの一覧を表示するには、以下のコマンドを実行します。

```sh
kubectl exec circleci-nomad-0 -it -- nomad node-status
```

NOTE: `nomad node-status` コマンドを実行すると、現在稼働中の Nomad クライアント (ステータスが `active`) と、クラスタから除外された Nomad クライアント (ステータスが `down`) の両方が報告されます。そのため、現在のクラスタの容量を知るには、ステータスが `active` の Nomad クライアントの数を数える必要があります。

特定のクライアントの詳細情報を表示するには、そのクライアントで以下のコマンドを実行します。

NOTE: インストール時の最初の Terraform セットアップ プロセスで有効な SSH キーが指定されていない場合、以下の手順は正しく機能しません。

.クライアントに SSH 接続します。
.以下のコマンドを実行して、クライアントのステータス情報を取得します。
+
```sh
nomad node-status -self
```

上記の手順を行うと、クライアント上で実行中のジョブの数や、クライアントのリソースの利用状況などの情報が表示されます。

=== ログの確認

Nomad ジョブのセクションで前述したように、このジョブは CircleCI ジョブの実行と対応しています。そのため、CircleCI ジョブで問題が発生した場合、Nomad ジョブのログを確認すると、そのジョブのステータスを理解するのに役立つことがあります。特定のジョブのログを表示するには、以下の手順を行います。

.以下のコマンドを実行して Nomad ジョブ ID を取得します。
+
```sh
kubectl exec circleci-nomad-0 -it -- nomad status
```
.ステップ 1 で取得した Nomad ジョブ ID を代入して以下のコマンドを実行し、そのジョブのログを表示します。
+
```sh
kubectl exec circleci-nomad-0 -it -- nomad logs -job -stderr <job-id>
```

NOTE: `-stderr` フラグは必ず指定してください。これにより、ほとんどのビルド エージェント ログが表示されます。

`nomad logs -job` は便利なコマンドですが、`-job` フラグでは指定されたジョブのランダム割り当てを使用するため、必ずしも正確であるとは限りません。`割り当て`は Nomad ジョブ内のさらに小さい単位です。これについては、このドキュメントでは取り上げません。詳しくは、https://www.nomadproject.io/docs/internals/scheduling.html[Nomad の公式ドキュメント]を参照してください。

指定したジョブの割り当てからログを取得するには、以下の手順を行います。

.以下のコマンドを実行して、ジョブ ID を取得します。
+
```sh
kubectl exec circleci-nomad-0 -it -- nomad status
```
.以下のコマンドを実行して、ジョブの割り当て ID を取得します。
+
```sh
kubectl exec circleci-nomad-0 -it -- nomad status <job-id>
```
.以下のコマンドを実行して、割り当てのログを表示します。
+
```sh
kubectl exec circleci-nomad-0 -it -- nomad logs -stderr <allocation-id>
```

=== クラスタのスケールアップ

Nomad クラスタは、デフォルトで AWS インスタンスの Auto Scaling グループ (ASG) 内、または GCP インスタンスのインスタンス グループ内にセットアップされます。設定内容を表示するには、お使いのインフラストラクチャに応じて以下の手順を行います。

==== AWS

.EC2 ダッシュボードにアクセスし、左側のメニューから [Auto Scaling Groups (Auto Scaling グループ)] を選択します。
.Nomad クライアントを選択します。
.[Actions (操作)] > [Edit (編集)] を選択し、[Desired (必要)]、[Minimum (最小)]、[Maximum (最大)] のそれぞれに容量の数値を設定します。この設定により、スピンアップされて利用可能になる Nomad クライアントの数が決まります。[Scaling Policy (スケーリング ポリシー)] タブを使用すると、ピーク時にグループを自動的にスケールアップできます。スケーリング ポリシーの定義に関するベスト プラクティスについては、後述します。<<monitoring#nomad-job-metrics,Nomad ジョブのメトリクス>>も、スケーリング ポリシーの定義に役立ちます。

==== GCP

.GCP コンソールにアクセスし、[Compute Engine] > [インスタンス グループ] を選択します。
.お使いの Nomad クラスタを見つけます。プレフィックスには`ベース名`が使用され、名前に `nomad` という語が含まれています。
.[グループを編集] を選択します。
.常時稼働させておくノードの数を指定するか、[自動スケーリングを構成] をクリックして自動スケーリングをセットアップできます。GCP 自動スケーリング ポリシーの設定に関する詳細については、https://cloud.google.com/compute/docs/autoscaler/#policies[GCP のドキュメント]を参照してください。

==== スケーリング ポリシーのベスト プラクティス

https://circleci.com/ja/blog/mathematical-justification-for-not-letting-builds-queue/[こちらのブログ記事]では、CircleCI のエンジニアリング チームが自動スケーリングの一般的なベスト プラクティスを見つけるために取り組んだコスト削減のシミュレーションについてシリーズで解説しています。その取り組みから得られたベスト プラクティスを紹介しますので、自動スケーリングをセットアップする際の参考としてください。

.原則として、クラスタのサイズは、ビルドがキューに入るのを避けられるよう十分な大きさにしましょう。具体的には、キューの待ち時間が、一般的なワークロードでは 1 秒未満に、コストの高いハードウェアや最大レベルの並列処理で実行されるワークロードでは 10 秒未満になるようにします。開発者の時間には高いコストがかかるため、待ち時間が 0 になるようサイズを調整するのがベスト プラクティスです。アンダープロビジョニングでも費用対効果が得られるほど開発者の時間コストを低く見積もるモデルを構築するのは難しいでしょう。

.大多数の開発者が勤務している時間帯にはスケールアップし、夜間はスケールダウンするようなステップ スケーリング ポリシーを適用した Auto Scaling グループ/インスタンス グループを作成します。平日の勤務時間中にスケールアップし、夜間にスケールダウンしておくことで、トラフィックが少ない夜間にオーバープロビジョニングを発生させることなく、開発のピーク時に待ち時間を抑制するのがベスト プラクティスです。なお、これまでの大量のビルド データを分析すると、通常の勤務時間中のデータセットはおおむね正規分布になっています。

上記は、トラフィックの変動に基づく自動スケーリングを 1 日中行う状況には当てはまりません。起動に長く時間がかかりすぎるため、リアルタイムにはキューイングを行えないことがモデリングから明らかになっています。そのような状況では、http://docs.aws.amazon.com/autoscaling/latest/userguide/as-scaling-simple-step.html[ステップ ポリシーに関する Amazon のドキュメント]に従って、Auto Scaling に CloudWatch アラームを設定してください。

=== Nomad クライアントのシャットダウン

Nomad クライアントをシャットダウンするときは、まずクライアントをドレイン (`drain`) モードに設定する必要があります。`drain` モードのクライアントでは、それまでに割り当てられたジョブは完了しますが、新たにジョブを割り当てることはできません。 

NOTE: インストール時の最初の Terraform セットアップ プロセスで有効な SSH キーが指定されていない場合、以下の手順は正しく機能しません。

.クライアントをドレイン モードにするには、クライアントに SSH 接続し、`node-drain` コマンドを以下のように実行します。
+
```sh
nomad node-drain -self -enable
```
.`node-status` コマンドを使用して、クライアントがドレイン モードに変更されていることを確認します。
+
```sh
nomad node-status -self
```

また、下記のコマンドにノード ID を代入して実行し、Nomad サーバーからリモート ノードをドレイン モードに設定することもできます。
```sh
kubectl exec circleci-nomad-0 -it -- nomad node-drain -enable -yes <node-id>
```

=== クライアント クラスタのスケールダウン

クライアントをシャットダウンするメカニズムを設定するには、まずクライアントを `drain` モードに変更し、すべてのジョブが完了してから、クライアントを終了させます。AWS にインストールしている場合は、https://docs.aws.amazon.com/autoscaling/ec2/userguide/lifecycle-hooks.html[ASG ライフサイクル フック]を構成することで、インスタンスをスケールダウンするスクリプトをトリガーできます。

このスクリプトで、上述のコマンドを使用して以下の手順を実行します。

.インスタンスをドレイン モードに設定します。
+
```shell
nomad node-drain -self -enable
```
.インスタンスで実行中のジョブをモニタリングし、ジョブが完了するのを待ちます。
.インスタンスを終了します。
