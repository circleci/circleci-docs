= Create, test, and publish a registry orb
:page-platform: Cloud, Server v4+
:page-description: Tutorial showing how to create an orb using the orb development kit.
:experimental:
:page-aliases: create-an-orb

This tutorial guides you through creating a new registry orb using the orb development kit. The starting point is creating a new repository on link:https://github.com[GitHub.com].

[NOTE]
====
This guide covers **registry orbs**. CircleCI supports three types of orbs:

* **Inline orbs**: Project-specific orbs defined in your config file. See xref:create-an-inline-orb.adoc[Create an inline orb].
* **URL orbs**: Organization-wide orbs hosted at a URL. See xref:create-test-and-use-url-orbs.adoc[Create, test, and use URL orbs].
* **Registry orbs**: Publicly or privately published orbs with semantic versioning (this guide).

Choose registry orbs when you need semantic versioning, public discoverability, or want to share with the CircleCI community. For a comparison, see xref:use:orb-concepts.adoc#orb-types-comparison[Orb types comparison].
====

Following this tutorial you will:

* Create a GitHub repository for your registry orb.
* Add template orb configuration, based on your requirements.
* Set up a CI/CD pipeline for orb development, and put restrictions on who can contribute.

At the end of the tutorial you will be ready to configure your registry orb.

These steps are also outlined in the following video:

.Create and initialize an orb
video::5ta4RUwqOBI[youtube]

[#prerequisites]
== Prerequisites

* A GitHub account connected to your CircleCI account. See the xref:guides:getting-started:first-steps.adoc[Sign up and try] page for steps to get set up.
* xref:guides:toolkit:local-cli.adoc#installation[Set up the CircleCI CLI] on your local machine with a link:https://app.circleci.com/settings/user/tokens[personal access token]. Ensure you are using the latest version of the CircleCI CLI. You must be using version `v0.1.17087` or later.
+
```shell
circleci update

circleci version
```
* Register a namespace for your GitHub organization. Every organization registered on CircleCI is able to claim *one* unique xref:use:orb-concepts.adoc#namespaces[namespace]. This includes your personal organization and any organization you are a member of. As each organization or user account is limited to a single namespace, in order to register the namespace for an organization you must be the _owner_ of the organization.
+
Enter the following command to claim your namespace, if you have not yet claimed one:
+
[,shell]
----
circleci namespace create <name> --org-id <your-organization-id>
----
+
NOTE: Find your organization ID in the CircleCI web app by navigating to *Organization Settings* from the sidebar..

[#create-your-orb]
== Create your orb

WARNING: Once an orb is created it cannot be deleted. Orbs are link:https://semver.org/[SemVer compliant], and each published version is immutable. Publicly released orbs are potential dependencies for other projects. Therefore, allowing orb deletion would make users susceptible to unexpected loss of functionality.

[#create-a-new-repo]
=== 1. Create a new repository

Create a new, empty, link:https://github.com/new[GitHub repository]. The name of your repository is not critical, but something similar to "myProject-orb" is recommended.

CAUTION: Ensure that the repository is completely empty. Uncheck any options such as "Add a README.md" or "Choose a license".

image::guides:ROOT:new_orb_repo_gh.png[New GitHub repository]

Once complete, you should see the generated git URL. Note it down, you will need it in step 4. You can select SSH or HTTPS, whichever you can authenticate with.

image::guides:ROOT:github_new_quick_setup.png[Orb registry]

CAUTION: Do not pull down the orb repository at this point. This will be completed when you run `orb init` in the next step. Pulling the repository before this can cause issues.

=== 2. Initialize your orb

Open a terminal and initialize your new orb project using the `orb init` CLI command as shown below. Use the `--private` flag if required. The `circleci orb init` command is called, followed by a path to create and initialize for your orb project. It is best practice to use the same name for this directory and the git repository.

WARNING: Once an orb is initialized, it **cannot be switched from public to private or vice versa**. Ensure you add the `--private` flag if you intend to create a private orb.

NOTE: The `--private` flag is not currently supported on CircleCI server. Orbs created within a server installation will only be visible to authenticated users.

* To initialize a xref:use:orb-intro.adoc#public-or-private[public] orb:
+
```shell
circleci orb init </path/to/myProject-orb>
```

* To initialize a xref:use:orb-intro.adoc#public-or-private[private] orb:
+
```shell
circleci orb init </path/to/myProject-orb> --private
```

=== 3. Choose the fully automated orb setup option

Choose `Yes, walk me through the process.` when prompted.

```shell
? Would you like to perform an automated setup of this orb?:
   â–¸  Yes, walk me through the process.
      No, I will handle everything myself.
```

When choosing the fully automated option, the link:https://github.com/CircleCI-Public/Orb-Template[orb template] is downloaded and automatically modified with your customized settings. The project will be followed on CircleCI with an automated CI/CD pipeline included.

For more information on the included CI/CD pipeline, see the xref:creating-orbs.adoc[Orb publishing process] page.

NOTE: If you would like a convenient way to download the link:https://github.com/CircleCI-Public/Orb-Template[orb template] you can opt to handle everything yourself. When choosing the manual option, see xref:manual-orb-authoring-process.adoc[Manual orb authoring process] for instructions on how to author and publish your orb.

==== GitHub App integration additional steps

If you have a `circleci` type organization you will need to follow some extra steps, as listed below. For more information on organization types, see the xref:guides:permissions-authentication:users-organizations-and-integrations-guide.adoc[Users, organizations, and integrations guide].

* When prompted, `Are you using GitHub or Bitbucket or GitHub app (if GH App use circleci as the entry)?`, enter `circleci`.
* When prompted, `Enter your circleci username or organization`, you will need to inspect the URL from the CircleCI web app and provide the org ID portion:
.. Navigate to the link:https://app.circleci.com[CircleCI web app]
.. The URL will be in the form: `\https://app.circleci.com/pipelines/circleci/<org-ID-string>`. The last string is the org ID that you need.
* At the end of the automated set up process you will receive an error: `Error: Could not follow project`. At this point you need to push your project up to GitHub, and set it up in a new CircleCI project. Steps for creating a new project can be found on the xref:guides:getting-started:create-project.adoc[Create a project] page.
* Once you have your orb pushed up to GitHub and your project set up, you will need to make a few manual updates:
** In `config.yml` and `test-deploy-yml`, update `vcs_type: << pipeline.project.type >>` to be `vcs_type: github`.
** In `src/@orb.yml` update `source_url: <orb URL>` to be `source_url: "https://github.com/<your-github-user-or-org-name>/<your-orb-repo-name>"`.

=== 4. Follow the prompts to set up your orb

In the background, the `orb init` command copies and customizes the link:https://github.com/CircleCI-Public/Orb-Template[orb template] based on your inputs. There are detailed `README.md` files within each directory that contain helpful information specific to the contents of each directory. You will be asked for the remote git repository URL that you obtained back in step 1.

The link:https://github.com/CircleCI-Public/Orb-Template[orb template] contains a full CI/CD pipeline (described in xref:creating-orbs.adoc[orb publishing process]), which automatically xref:use:orb-concepts.adoc#orb-packing[packs], xref:testing-orbs.adoc[tests], and xref:creating-orbs.adoc[publishes] your orb.

In the setup process you will be asked if you would like to save your xref:guides:toolkit:managing-api-tokens.adoc[personal API Token] into an `orb-publishing` xref:guides:security:contexts.adoc[context]. Saving this token is necessary for publishing development and production versions of your orb. If you have already made an orb in the past, you can skip this step, as the context will already exist.

=== 5. Restrict who can trigger jobs for the orb

Use xref:guides:security:contexts.adoc#restrict-a-context-to-a-security-group-or-groups[security groups] to limit access to users that are allowed to trigger jobs. Only these users will have access to the private xref:guides:toolkit:managing-api-tokens.adoc[personal API token].

xref:guides:security:contexts.adoc#restrict-a-context[Contexts] can be located by navigating to **Organization Settings > Contexts** in the web app. After creating your orb, you will have a new context called `orb-publishing`. Click into `orb-publishing` and add a **Security Group**.

.Secure contexts
video::ImPE969yv08[youtube]

=== 6. Push changes to GitHub

During the setup process, the `orb init` command prepares your automated orb development pipeline. The modified template code produced by the CLI must be pushed to the repository before the CLI can continue and automatically follow your project on CircleCI.

Run the following command from a separate terminal when prompted to do so, substituting the name of your default branch:

```shell
git push origin <default-branch>
```

Once complete, return to your terminal and confirm the changes have been pushed.

=== 7. Complete the setup

Once the changes have been pushed, return to your terminal and continue the setup process. The CLI will now automatically follow the project on CircleCI, and attempt to trigger a pipeline to build and test your orb with sample code.

You will be provided with a link to the project building on CircleCI where you can view the full pipeline. You should also see the CLI has automatically migrated you into a new development branch, named `alpha`. You can use any branch naming you would like, you do not need to exclusively develop on `alpha`.

=== 8. Develop your orb

From a non-default branch (you will be moved to the `alpha` branch automatically at setup), begin modifying the sample orb code to fit your requirements. On each _push_, your orb will be automatically built and tested. More information on developing your orb can be found in the next section.

Be sure to view the `.circleci/test-deploy` link:https://github.com/CircleCI-Public/Orb-Template/blob/main/.circleci/test-deploy.yml[file] to view how your orb components are being tested. You can modify your tests as you change your orb. Learn more about testing your orb on the xref:testing-orbs.adoc[Orb testing methodologies] page.

When you are ready to deploy the first production version of your orb, head to the xref:creating-orbs.adoc[Orb publishing process] page.

.Build and test an orb
video::kTeRJrwxShI[youtube]

[#writing-your-orb]
=== Writing your orb

Before you begin working on your orb, ensure you are on a non-default branch. We typically recommend starting your orb on the `alpha` branch.

[,shell]
----
$ git branch

* alpha
  main
----

If you have run the `circleci orb init` command, you will automatically be in the `alpha` branch and have a repository with `.circleci` and `src` directories.

.Orb Project Structure

[.table-scroll]
--
[cols=2*, options="header"]
|===
| type | name

| Directory
| link:https://github.com/CircleCI-Public/Orb-Template/tree/main/.circleci[`.circleci`]

| Directory
| link:https://github.com/CircleCI-Public/Orb-Template/tree/main/.github[`.github`]

| Directory
| link:https://github.com/CircleCI-Public/Orb-Template/tree/main/src[`src`]

| File
| link:https://github.com/CircleCI-Public/Orb-Template/blob/main/.gitignore[`.gitignore`]

| File
| link:https://github.com/CircleCI-Public/Orb-Template/blob/main/LICENSE[`LICENSE`]

| File
| link:https://github.com/CircleCI-Public/Orb-Template/blob/main/README.md[`README.md`]
|===
--

[#orb-source]
==== Orb source

Navigate to the `src` directory to look at the included sections.

.Orb Project `src` Directory

[.table-scroll]
--
[cols=2*, options="header"]
|===
| type | name

| Directory
| link:https://github.com/CircleCI-Public/Orb-Template/tree/main/src/commands[`commands`]

| Directory
| link:https://github.com/CircleCI-Public/Orb-Template/tree/main/src/examples[`examples`]

| Directory
| link:https://github.com/CircleCI-Public/Orb-Template/tree/main/src/executors[`executors`]

| Directory
| link:https://github.com/CircleCI-Public/Orb-Template/tree/main/src/jobs[`jobs`]

| Directory
| link:https://github.com/CircleCI-Public/Orb-Template/tree/main/src/scripts[`scripts`]

| File
| link:https://github.com/CircleCI-Public/Orb-Template/blob/main/src/%40orb.yml[`@orb.yml`]
|===
--

The directories listed above represent orb components that can be included with your orb. @orb.yml acts as the root of your orb. In addition to the directories representing your orb's YAML components, you will also see a <<scripts,`scripts`>> directory where we can store code we want to inject into our components.

Each directory within `src` corresponds with a xref:reference:ROOT:reusing-config.adoc[reusable configuration] component type, which can be added or removed from the orb. If, for example, your orb does not require any `executors` or `jobs`, these directories can be deleted.

[#orbyml]
==== @orb.yml

@orb.yml acts as the "root" to your orb project and contains the config version, the orb description, the display key, and imports any additional orbs if needed.

Use the `display` key to add clickable links to the orb registry for both your `home_url` (the home of the product or service), and `source_url` (the git repository URL).

[,yaml]
----
version: 2.1

description: >
  Sample orb description

display:
  home_url: "https://www.website.com/docs"
  source_url: "https://www.github.com/EXAMPLE_ORG/EXAMPLE_PROJECT"
----

[#commands]
==== Commands

Author and add xref:reference:ROOT:reusing-config.adoc#authoring-reusable-commands[Reusable Commands] to the `src/commands` directory. Each _YAML_ file within this directory will be treated as an orb command, with a name which matches its filename.

This example shows a simple command which contains a single `run` step, which will echo "hello" and the value passed in the `target` parameter.

[,yaml]
----
description: >
  # What will this command do?
  # Descriptions should be short, simple, and clear.
parameters:
  target:
    type: string
    default: "Hello"
    description: "To whom to greet?"
steps:
  - run:
      name: Hello World
      environment:
        ORB_PARAM_TARGET: << parameters.target >>
      command: echo "Hello ${ORB_PARAM_TARGET}"
----

[#examples]
==== Examples

Author and add xref:use:orb-concepts.adoc#usage-examples[Usage Examples] to the `src/examples` directory. Usage examples are not for use directly by end users in their configs. They provide a way for you to share use-case specific examples for users to reference.

Each _YAML_ file within this directory will be treated as an orb usage example, with a name which matches its filename.

View a full example from the link:https://github.com/CircleCI-Public/Orb-Template/tree/main/src/examples[Orb Template].

[#executors]
==== Executors

Author and add xref:reference:ROOT:reusing-config.adoc#authoring-reusable-executors[Parameterized Executors] to the `src/executors` directory.

Each _YAML_ file within this directory will be treated as an orb executor, with a name that matches its filename.

View a full example from the link:https://github.com/CircleCI-Public/Orb-Template/tree/main/src/executors[Orb Template].

[#jobs]
==== Jobs

Author and add xref:reference:ROOT:reusing-config.adoc#authoring-parameterized-jobs[Parameterized Jobs] to the `src/jobs` directory.

Each _YAML_ file within this directory will be treated as an orb job, with a name that matches its filename.

Jobs can include orb commands and other steps to fully automate tasks with minimal user configuration.

View the link:https://github.com/CircleCI-Public/Orb-Template/blob/main/src/jobs/hello.yml[hello.yml] job example from the link:https://github.com/CircleCI-Public/Orb-Template/tree/main/src/jobs[Orb Template].

[,yaml]
----
description: >
  # What will this job do?
  # Descriptions should be short, simple, and clear.

docker:
  - image: cimg/base:current
parameters:
  greeting:
    type: string
    default: "Hello"
    description: "Select a proper greeting"
steps:
  - greet:
      greeting: "<< parameters.greeting >>"
----

[#scripts]
==== Scripts

One of the major benefits of the orb development kit is a xref:use:orb-concepts.adoc#file-include-syntax[script inclusion] feature. When using the `circleci orb pack` command (automated with the orb development kit), you can use `++<<include(file)>>++` within your orb config code to include the file contents directly in the orb.

Script inclusion is especially useful when writing complex orb commands, which might contain a lot of _Bash_ code, _(although you could use Python too!)_.

[tabs]
====
Orb Development Kit packing::
+
--
[,yaml]
----
parameters:
  to:
    type: string
    default: "World"
    description: "Hello to whom?"
steps:
  - run:
      environment:
        PARAM_TO: <<parameters.to>>
      name: Hello Greeting
      command: <<include(scripts/greet.sh)>>
----
--
Standard YAML config::
+
--
[,yaml]
----
parameters:
  to:
    type: string
    default: "World"
    description: "Hello to whom?"
steps:
  - run:
      name: Hello Greeting
      command: echo "Hello <<parameters.to>>"
----
--
====

[#why-include-scripts]
==== Why include scripts?

CircleCI configuration is written in `YAML`. Logical code such as `bash` can be encapsulated and executed on CircleCI through `YAML`, but, for developers, it is not convenient to write and test programmatic code within a non-executable format. Also, parameters can become cumbersome in more complex scripts as the `\<<parameter>>` syntax is a CircleCI native YAML enhancement, and not something that can be interpreted and executed locally.

Using the orb development kit and the `\<<include(file)>>` syntax, you can:

* Import existing scripts into your orb.
* Locally execute and test your orb scripts.
* Utilize true testing frameworks for your code.

[#using-parameters-with-scripts]
==== Using parameters with scripts

To keep your scripts portable and locally executable, it is best practice to expect a set of environment variables within your scripts and set them at the config level. The `greet.sh` file, which was included with the special `\<<include(file)>>` syntax above in our `greet.yml` command file, looks like this:

[,shell]
----
echo Hello "${PARAM_TO}"
----

This way, you can both mock and test your scripts locally.

[#testing-orbs]
=== Testing orbs

Much like any software, to ensure quality updates, we must test our changes. Various tools are available for testing your orb, from simple validation, to unit and integration testing.

In the `.circleci/` directory created by the orb development kit, you will find a `config.yml` file and a `test-deploy.yml` file. You will find in the `config.yml` file, the different static testing methods we apply to orbs, such as linting, shellchecking, reviewing, validating, and in some cases, unit testing. While, the `test-deploy.yml` config file is used to test a development version of the orb for integration testing.

Read our full xref:testing-orbs.adoc[Orb Testing Methodologies] documentation.

[#publishing-your-orb]
=== Publishing your orb

With the orb development kit, a fully automated CI and CD pipeline is automatically configured within `.circleci/config.yml`. This configuration makes it simple to automatically deploy semantically versioned releases of your orbs.

For more information, see the xref:creating-orbs.adoc[Orb Publishing Process] guide.