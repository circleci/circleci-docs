= Using Smarter Testing Locally
:page-description: Run Smarter Testing features on your local machine

You can use Smarter Testing locally to benefit from intelligent test selection and dynamic test distribution before pushing to CI. This helps you iterate faster during development.

== Prerequisites

Before using Smarter Testing locally, ensure you have:

* Completed the xref:getting-started.adoc[Getting Started] guide
* Installed the `testsuite` CLI plugin
* Configured your `.circleci/test-suites.yml`
* (Optional) Enabled xref:test-impact-analysis.adoc[Test Impact Analysis] in your configuration

== Running tests locally

There are two ways to run Smarter Testing locally:

=== Option 1: Using local impact data only

Run with the `--local` flag to use only locally-generated impact data:

[source,console]
----
$ circleci run testsuite "ci tests" --local
----

This mode:
* Uses impact data from `.circleci/impact.json` if it exists
* Does not require CircleCI API access
* Does not fetch impact data from CircleCI
* Runs analysis if configured (to build/update local impact data)

=== Option 2: Using impact data from CircleCI

Run without the `--local` flag to leverage impact data stored in CircleCI:

[source,console]
----
$ circleci run testsuite "ci tests"
----

This mode:
* Fetches the latest impact data from your CircleCI project
* Provides the same test selection as CI runs
* Requires CircleCI API token configuration
* Never runs analysis locally (only test selection)

TIP: This is the recommended approach as it uses the most up-to-date impact data from your team's CI runs.

== Set up CircleCI API access

To use impact data from CircleCI, you need to configure your API token.

=== Get your CircleCI API token

. Navigate to https://app.circleci.com/settings/user/tokens[User Settings > Personal API Tokens]
. Create a new token or use an existing one
. Copy the token value

=== Configure via CLI

Run the CircleCI CLI setup command and follow the prompts:

[source,console]
----
$ circleci setup
----

This will configure your token for all future `testsuite` commands.

For more details, see the xref:toolkit:local-cli.adoc#configure-the-cli[Configure the CLI Guide].

=== Configure via command line

You can also provide the token directly when running the command:

[source,console]
----
$ circleci run testsuite "ci tests" --circleci-token=<your-token>
----

== Using Test Impact Analysis locally

When Test Impact Analysis is enabled, Smarter Testing will intelligently select which tests to run based on your local code changes.

=== With impact data from CircleCI

[source,console]
----
$ circleci run testsuite "ci tests"
----

This will:
1. Fetch the latest impact data from CircleCI
2. Compare your local changes against that impact data
3. Select only the tests affected by your changes
4. Run the selected tests

NOTE: Analysis is always disabled when running without the `--local` flag, regardless of the `--test-analysis` flag value. This prevents expensive analysis runs on developer machines.

=== With local impact data

[source,console]
----
$ circleci run testsuite "ci tests" --local
----

This will:
1. Use impact data from `.circleci/impact.json` if it exists
2. Select tests based on your local changes
3. Run the selected tests
4. Optionally run analysis to update local impact data (based on configuration)

NOTE: When running with `--local`, you will see `.circleci/impact.json` created in your project. This file stores the impact data used for test selection.

=== Building local impact data

If you want to build or refresh your local impact data:

[source,console]
----
$ circleci run testsuite "ci tests" --local --test-selection=none --test-analysis=impacted
----

This will:
1. Skip running tests (`--test-selection=none`)
2. Run analysis on tests affected by your changes (`--test-analysis=impacted`)
3. Update `.circleci/impact.json` with new impact data

TIP: You can timebox the analysis by setting `options.test-analysis-duration` in your test suite configuration to avoid long waits.

== Using Dynamic Test Distribution locally

When you run Smarter Testing locally, tests are sorted by duration (longest first) if timing data is available, but they run sequentially since parallelism requires multiple execution nodes.

[source,console]
----
$ circleci run testsuite "ci tests" --local
----

Look for this in the output to confirm timing data is being used:

[source,console]
----
Discovering...
Discovered 50 tests in 200ms

Selecting tests...
Selected 50 tests, Skipped 0 tests in 5ms

Autodetected filename timings for 48 tests
Sorted tests in 8ms

Running tests...
----

While tests won't be split across parallel nodes locally, running longer tests first can help you identify issues faster during development.

== Project ID detection

Smarter Testing attempts to auto-detect your CircleCI project ID when running without `--local`. If auto-detection fails (common for standalone projects), you'll need to provide it manually:

[source,console]
----
$ circleci run testsuite "ci tests" --project-id=<your-project-id>
----

To find your project ID:
1. Go to your project in CircleCI
2. Navigate to Project Settings
3. Copy the Project ID from the Overview section

== Common workflows

=== Quick test run with CI impact data

Run only the tests affected by your changes using the latest impact data from CI:

[source,console]
----
$ circleci run testsuite "ci tests"
----

=== Test run with local-only data

Run tests using only your local impact data (no API calls):

[source,console]
----
$ circleci run testsuite "ci tests" --local
----

=== Build local impact data for offline use

Generate impact data locally for a subset of tests:

[source,console]
----
$ circleci run testsuite "ci tests" --local --test-selection=none --test-analysis=impacted
----

=== Run all tests locally

Force running all tests regardless of impact analysis:

[source,console]
----
$ circleci run testsuite "ci tests" --local --test-selection=all
----

=== Debug mode

Get detailed output for troubleshooting:

[source,console]
----
$ circleci run testsuite "ci tests" --local --verbose
----

== Understanding local behavior

=== Default flags when running locally

When you run with `--local`:
* `--test-selection` defaults to `impacted`
* `--test-analysis` defaults to `none`

When you run without `--local`:
* `--test-selection` defaults to `impacted`
* `--test-analysis` is always `none` (cannot be changed)

=== File creation

Running tests locally may create several files in your project:

* `.circleci/impact.json` - Impact data for test selection (when using `--local`)
* `test-reports/` - JUnit XML test results
* `coverage/` - Coverage data (when running analysis)

These files are safe to delete and will be regenerated as needed. Consider adding them to your `.gitignore`:

[source,gitignore]
----
# .gitignore
.circleci/impact.json
test-reports/
coverage/
----

== Troubleshooting

=== Cannot auto-detect project ID

*Symptoms:* Error message about unable to detect project ID.

*Solution:* Provide the project ID explicitly:

[source,console]
----
$ circleci run testsuite "ci tests" --project-id=<your-project-id>
----

=== No impact data available

*Symptoms:* Message "Selecting all tests, no impact analysis available" even though Test Impact Analysis is enabled.

*Solution:* This happens when:
1. Impact analysis hasn't run in CI yet - push a branch and let analysis run
2. Using `--local` but no local impact data exists - run analysis locally first
3. Impact data is outdated - run analysis in CI or locally to refresh

=== Tests are slow locally

*Symptoms:* Local test runs take much longer than expected.

*Solution:* If you're running analysis locally (`--test-analysis=impacted`), this is expected as each test runs individually with coverage. Consider:

1. Use impact data from CircleCI instead (don't use `--local`)
2. Timebox analysis with `options.test-analysis-duration`
3. Only run analysis when you need to update impact data

=== Authentication errors

*Symptoms:* Errors about invalid or missing CircleCI token.

*Solution:* 
1. Verify your token is valid at https://app.circleci.com/settings/user/tokens[Personal API Tokens]
2. Re-run `circleci setup` to configure the token
3. Or provide the token directly: `--circleci-token=<your-token>`

== Frequently Asked Questions

=== Should I use --local or fetch data from CircleCI?

**Recommended: Fetch from CircleCI** (no `--local` flag)

Advantages:
* Always uses the most up-to-date impact data from your team
* No need to run expensive analysis locally
* Same test selection as CI runs
* No local files to manage

Use `--local` when:
* Working offline without CI access
* Testing/debugging test selection behavior
* Building impact data for a personal branch not yet in CI

=== Does running locally affect my CI impact data?

No. Local runs (with or without `--local`) do not modify the impact data stored in CircleCI. Only CI runs with analysis enabled update the shared impact data.

=== Can I use parallelism locally?

No. Parallelism is a CircleCI feature that requires multiple execution nodes. Local runs execute tests sequentially, but they will still sort tests by duration if timing data is available.

=== How often should I update my local impact data?

If using `--local` mode:
* Update when your code changes significantly
* Update after major refactoring
* Update when test selection seems inaccurate

If fetching from CircleCI:
* No action needed - you always get the latest data automatically

=== Will local test runs be faster?

Yes, when Test Impact Analysis is enabled:
* You'll run fewer tests based on your changes
* Tests are sorted by duration (longest first)
* You can identify issues faster during development

However, if you run analysis locally, that initial run will be slower due to coverage instrumentation.

=== What's the difference between local and CI behavior?

[.table-scroll]
--
[cols=3*, options="header"]
|===
|Aspect|Local (with --local)|Local (without --local)|CI

|Impact data source
|`.circleci/impact.json`
|Fetched from CircleCI
|Stored in CircleCI

|Analysis runs
|Based on configuration
|Never
|Based on configuration

|Parallelism
|Sequential only
|Sequential only
|Supports parallelism

|API calls
|None
|Required
|Required

|Updates shared data
|No
|No
|Yes
|===
--
