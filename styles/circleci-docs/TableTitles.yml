---
extends: script
scope: raw
level: warning
message: "Tables should have a title (line starting with '.' before the table)."
link: https://github.com/circleci/circleci-docs
script: |
  text := import("text")
  matches := []

  lines := text.split(scope, "\n")
  in_table := false

  for i, line in lines {
    trimmed := text.trim_space(line)

    // Check for table delimiter
    if trimmed == "|===" {
      // Toggle table state
      if !in_table {
        // This is an opening delimiter
        has_title := false

        // Look back for a title, skipping empty lines, attributes, and block delimiters
        for j := i - 1; j >= 0; j-- {
          prev_trimmed := text.trim_space(lines[j])

          // Skip empty lines
          if prev_trimmed == "" {
            continue
          }

          // Skip attribute lines (start with [)
          if text.has_prefix(prev_trimmed, "[") {
            continue
          }

          // Skip block delimiters (lines with only dashes or equals signs)
          is_delimiter := text.re_match("^-+$", prev_trimmed) || text.re_match("^=+$", prev_trimmed)
          if is_delimiter {
            continue
          }

          // Skip comment lines (start with //)
          if text.has_prefix(prev_trimmed, "//") {
            continue
          }

          // Check if this line is a title (starts with a dot)
          if text.has_prefix(prev_trimmed, ".") {
            has_title = true
            break
          }

          // Found a non-skippable line that's not a title
          break
        }

        if !has_title {
          start := text.index(scope, line)
          matches = append(matches, {begin: start, end: start + len(line)})
        }

        in_table = true
      } else {
        // This is a closing delimiter, just toggle state
        in_table = false
      }
    }
  }
