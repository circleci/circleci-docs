---
extends: script
scope: raw
level: warning
message: "Tables should have a title (line starting with '.' before the table)."
link: https://github.com/circleci/circleci-docs
script: |
  text := import("text")
  matches := []

  lines := text.split(scope, "\n")
  table_delimiter_count := 0

  for i, line in lines {
    trimmed := text.trim_space(line)

    // Check for table delimiter
    if trimmed == "|===" {
      // Even count = opening delimiter, odd count = closing delimiter
      is_opening := table_delimiter_count % 2 == 0

      if is_opening {
        // Look back for a title, skipping empty lines, attributes, and block delimiters
        has_title := false

        for j := i - 1; j >= 0; j-- {
          prev_trimmed := text.trim_space(lines[j])

          // Skip empty lines, attribute lines, and block delimiters (-- or ==)
          if prev_trimmed == "" || text.has_prefix(prev_trimmed, "[") || prev_trimmed == "--" || prev_trimmed == "==" {
            continue
          }

          // Check if this line is a title
          if text.has_prefix(prev_trimmed, ".") {
            has_title = true
            break
          }

          // Found a non-attribute, non-empty line that's not a title
          break
        }

        if !has_title {
          start := text.index(scope, line)
          matches = append(matches, {begin: start, end: start + len(line)})
        }
      }

      table_delimiter_count = table_delimiter_count + 1
    }
  }
